---
title: "磁盘相关"
layout: post
date: 2017-06-15
tags:
- Linux
categories: LINUX
blog: true
excerpt: mbr和grub的关系，fdisk解析
---

### 基本概念

磁道 : 当磁盘旋转时，磁头若保持在一个位置上，则每个磁头都会在磁盘表面划出一个圆形轨迹，这些圆形轨迹就叫做磁道 。

扇区 : 磁盘上的每个磁道被等分为若干个弧段，这些弧段便是磁盘的扇区，每个扇区可以存放512个字节的信息，磁盘驱动器在向磁盘读取和写入数据时，要以扇区为单位

磁柱( 柱面 ) : 硬盘通常由重叠的一组盘片构成，每个盘面都被划分为数目相等的磁道，并从外缘的“0”开始编号，具有相同编号的磁道形成一个圆柱，称之为磁盘的柱面。磁盘的柱面数与一个盘面上的磁道数是相等的。由于每个盘面都有自己的磁头，因此，盘面数等于总的磁头数。

硬盘是以 sectors(扇区), cylinder(磁柱), partitions(分割槽) 这些东西来作为储存的单位，而最底层的实体硬盘单位就是 sectors 了，通常一个 sector 大约是 512 bytes 左右。不过，在磁盘进行格式化的时候，可以将数个 sector 格式化成为一个逻辑扇区(logical block)，通称为 block。blocks 为一个档案系统(filesystem)存取的最小量。所谓硬盘的CHS,即Cylinder（柱面）、Head（磁头）、  Sector（扇区），只要知道了硬盘的CHS的数目，即可确定硬盘的容量，硬盘的容量=柱面数×磁头数×扇区数×512B

###硬盘寻址方式

硬盘有两种寻址模式，一种就是C/H/S（Cylinder/Head/Sector）寻址模式，也可以称为三维地址模式，这是硬盘最早采用的寻址模式，当时硬盘的容量还非常小，人们采用与软盘类似的结构生产硬盘，也就是硬盘盘片的每一条磁道都具有相同的扇区数，由此产生了所谓的3D参数（Disk Geometry），既磁头数（Heads）、柱面数（Cylinders）、 扇区数（Sectors），以及相应的寻址方式。

在老式硬盘中，由于每个磁道的扇区数相等（与软盘一样），所以外磁道的记录密度要远低于内磁道，因此会浪费很多磁盘空间。为了解决这一问题，进一步提高硬盘容量（C/H/S寻址的容量是有限制的，后面会提到），人们改用等密度结构生产硬盘，也就是说，外圈磁道的扇区比内圈磁道多。采用这种结构后，硬盘不再具有实际的3D参数，寻址方式也改为线性寻址，即以扇区为单位进行寻址，这种寻址模式叫做LBA，全称为Logic Block Address（即扇区的逻辑块地址）。

扇区的三维物理地址与硬盘上的物理扇区一一对应，即三维物理地址可完全确定硬盘上的物理扇区。

而在LBA方式下，系统把所有的物理扇区都按照某种方式或规则看做是一个线性编号的扇区，即从0到某个最大值方式排列，并连成一条线，把LBA作为一个整体来对待，而不再是具体的实际的C/H/S值，这样只用一个序数就确定了一个惟一的物理扇区，显然线性地址是物理扇区的逻辑地址。

为了与使用C/H/S寻址的老软件兼容（如使用BIOS Int13H接口的软件）在硬盘控制器内部安装了一个地址翻译器，由它负责将C/H/S参数翻译成LBA地址。


### MBR


硬盘的最前端512个字节是有特殊用处的。 

* 0-446个字节是一段二进制程序，它将会引导电脑加载位于其他分区的引导程序。理论上将引导程序直接写到硬盘的最前面貌似也可以，就是引导程序大小不固定且一般比较大，所以才有了这么一个446字节的曲线救国策略吧。 
* 其后是4个16字节的“磁盘分区表”（DPT）。 它能记录的只能是主分区和扩展分区两种类型的表项。这4个记录可以是4个主分区，0个扩展分区；也可以是3个主分区，1个扩展分区；在MBR中的DPT中，主分区可以有1~4个，而扩展分区只能有1个。我们在扩展分区的基础上又可以创建若干个逻辑分区，所以扩展分区和逻辑分区是包含的关系。因此在扩展分区中的表项（即逻辑分区），硬盘编号只能从5开始，如/dev/hda5，主分区即使没有创建也会占用/dev/hda1-4
* 2字节的结束标志（55AA）

有人管硬盘0-446字节的内容叫MBR，也有人管0-512字节叫MBR。

磁盘分区表会描述某一个分区是从硬盘（U盘也行）的哪一个块开始，哪一个块结束的。对于一个U盘如果它不是用作启动盘的那么用0填充最前面的446个字节，U盘依然可以使用。如果填充接下来的64个字节，那么U盘就无法读取了，当然数据还是可以恢复的。

### GRUB

GRUB用来引导加载最终的操作系统。因为它尺寸比较大且有着不确定的大小，所以不能放在硬盘最前面。它可以被放到分区的某一个目录里面，然后由MBR的446个字节尝试加载我们配置好的GRUB。


### fdisk -l


```linux
[root@VM_16_98_centos ~]# fdisk -l

Disk /dev/vda: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x0005fc9a

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048    41943039    20970496   83  Linux

```


你可以看到这个硬盘21.5GB大小 (注：bytes=B，表示“字节”，bit=b，表示“位”)，分了一个区，每一个簇大小512字节，硬盘的布局是这样的： 

* 第0簇: MBR 
* 第1簇 - 2048簇 ：空白的
* 第2048簇 - 41943039簇： 第一个分区。 



分区与分区之间是可以有空隙的，这么做除了浪费空间貌似没有什么好处，所以很少有人这么做。第一个分区与MBR之间是有空隙的，这个倒是故意的，但是对于MBR格式的硬盘貌似也没有用处。

除此之外，你还可以看到Device里面有一个Boot字段，它表明了该分区是否可以启动。


/dev/sdb 和 /dev/sdb1 以及/dev/sdb2的关系是：/dev/sdb = MBR + 可能有的空隙 + /dev/sdb1 + 可能有的空隙 +  /dev/sdb2 + 可能有的空隙




```linux
[root@www.linuxidc.com ~]# fdisk -l 
Disk /dev/sda: 10.7 GB, 10737418240 bytes 
255 heads, 63 sectors/track, 1305 cylinders 
Units = cylinders of 16065 * 512 = 8225280 bytes 
Sector size (logical/physical): 512 bytes / 512 bytes 
I/O size (minimum/optimal): 512 bytes / 512 bytes 
Disk identifier: 0x00044938 
  Device Boot      Start        End      Blocks  Id  System 
/dev/sda1  *          1        638    5120000  83  Linux 
Partition 1 does not end on cylinder boundary. 
/dev/sda2            638        893    2048000  83  Linux 
Partition 2 does not end on cylinder boundary. 
/dev/sda3            893        1020    1024000  82  Linux swap / Solaris 
Partition 3 does not end on cylinder boundary. 
/dev/sda4            1020        1306    2292736    5  Extended 
/dev/sda5            1021        1306    2291712  83  Linux
```

- Disk /dev/sda: 10.7 GB, 10737418240 bytes: 块设备名称为/dev/sda，此设备的大小为10.7GB，这个数字不是特别精确，我系统是10GB；10737418240 bytes这是转换成字节后的大小，即：10737418240/1024/1024/1024=10GB (注：bytes=B，表示“字节”，bit=b，表示“位”)
- 255 heads, 63 sectors/track, 1305 cylinders: 255 heads：表示磁头数为255; 63 sectors/track：表示每磁道上有63个扇区; 1305 cylinders：表示共有1305个柱面，柱面是分区的最小单位
- Sector size (logical/physical): 512 bytes / 512 bytes表示一个扇区的大小是512字节
- Units = cylinders of 16065 * 512 = 8225280 bytes, 16065=255 * 63因为每一个磁头都是在同一个柱面的，63表示每个磁道上的扇区数量，这两个数的乘积表示一个柱面上的扇区数量；所以16065* 512表示一个柱面的大小是8225280字节


**总结：所以一个磁盘的大小=一个柱面大小* 柱面的总数=磁头数量* 每个磁道上的扇区数* 一个扇区大小* 柱面总数**

即：磁盘大小=8225280 * 1305=10733990400bytes=9.99GB=255 * 63 * 512 * 1305
上例中显示出我们的磁盘只有1305个柱面，但下边的分区信息中出现了1306个柱面数，不必太在意，linux显示的这些数据不会十分精确。



### 讨论

- mbr是硬盘的一个引导区，而grub是一个引导程序！在mbr中有一段空间需要编写引导程序！grub只是引导程序的一种！如果grub够小的话，直接写在mbr中，就可以引导操作系统了！如果grub太大，在只能写一部分在mbr了！如果装windows则硬盘中的grub程序就不能运行了！不是不行，而是微软不愿兼容其它操作系统程序！这些都是技术，技术会发展，可能与不可能只不过是时间和当时技术的问题！


- grub可写在mbr中(硬盘0扇区), 也可写在引导分区中(比如linux分区)。在安装linux系统时,有的发行版会有这两个选项.


- 磁道是在磁盘的外圈还是内圈？由于历史原因 ， 磁盘的0磁道在最外圈（过去的老式硬盘，每条磁道上的簇的数量都是一样多的。也就是说最里面和最外面的磁道的簇的数目是一样的。显然，磁密度越低，数据的安全越有保障。而MBR放在0柱面的，第0个磁道的，第1个簇上面，为了这个关键数据的安全，所以磁道要从最外开始安排。） 
但是，光盘的0磁道和磁盘，软盘刚好相反，光盘的0磁道是在最内圈的 。尽管扇区是能独立寻址的最小单位，但资源分配的最小单位是簇。所以文件的大小和文件所占用的磁盘空间是不同的。所占用的磁盘空间往往多余文件的大小 

- 硬盘簇的大小设为多少才合适？NTFS支持512／1024／2048／4096／8192／16K／32K／64KB 。簇的大小会影响到磁盘文件的排列，设置适当的簇大小可以减少磁盘空间丢失和分区上碎片的数量。如果簇设置过大，会影响到磁盘存储效率；反之如果设置过小，虽然会提高利用效率，但是会产生大量磁盘碎片.
